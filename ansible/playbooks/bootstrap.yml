# Bootstrap a Talos Kubernetes cluster from existing VMs
---
- name: Configure kubernetes cluster
  hosts: localhost
  connection: local
  vars:
    # The name to give the cluster in talos
    bootstrap_cluster_name: "{{ talos.cluster_name }}"
    # The endpoint for the bootstrap control plane
    bootstrap_control_plane_endpoint: "{{ talos.control_plane.endpoint }}"
    # The IPs of the control plane nodes to add to the cluster
    bootstrap_control_plane_ips: "{{ groups['k8s_control_planes'] }}"
    # The IPs of the worker nodes to add to the cluster
    bootstrap_worker_ips: "{{ groups['k8s_workers'] }}"
  roles:
    - role: generate_talos_configs
      vars:
        generate_talos_configs_cluster_name: "{{ bootstrap_cluster_name }}"
        generate_talos_configs_control_plane_endpoint: "{{ bootstrap_control_plane_endpoint }}"
        generate_talos_configs_out_dir: "{{ local.out_dir }}"
        generate_talos_configs_k8s_control_planes: "{{ bootstrap_control_plane_ips }}"
    - role: add_kubernetes_node
      vars:
        add_kubernetes_node_type: controlplane
        add_kubernetes_node_ips: "{{ bootstrap_control_plane_ips }}"
        add_kubernetes_node_config_dir: "{{ local.out_dir }}"
    - role: bootstrap_etcd
    - role: add_kubernetes_node
      vars:
        add_kubernetes_node_type: worker
        add_kubernetes_node_ips: "{{ bootstrap_worker_ips }}"
        add_kubernetes_node_config_dir: "{{ local.out_dir }}"
