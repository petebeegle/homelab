# yaml-language-server: $schema=https://json-schema.org/draft/2020-12/schema
---
version: 1
metadata:
  name: grafana-oauth2-setup
  labels:
    blueprints.goauthentik.io/instantiate: "true"
context:
  grafana_client_id: grafana
  grafana_client_secret: !Env GRAFANA_OAUTH_CLIENT_SECRET

entries:
  # Groups for Grafana role mapping
  - identifiers:
      name: Grafana Admins
    model: authentik_core.group
    attrs:
      name: Grafana Admins

  - identifiers:
      name: Grafana Editors
    model: authentik_core.group
    attrs:
      name: Grafana Editors

  # Custom property mapping for groups
  - identifiers:
      managed: goauthentik.io/providers/oauth2/grafana-groups
    model: authentik_providers_oauth2.scopemapping
    attrs:
      name: Grafana Groups Mapping
      scope_name: groups
      expression: |
        return {
          "groups": [group.name for group in request.user.ak_groups.all()],
        }

  # OAuth2 Provider for Grafana
  - identifiers:
      name: grafana-provider
    model: authentik_providers_oauth2.oauth2provider
    attrs:
      name: Grafana OAuth Provider
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-invalidation-flow]]
      client_type: confidential
      client_id: !Context grafana_client_id
      client_secret: !Context grafana_client_secret
      redirect_uris:
        - matching_mode: strict
          url: https://monitoring.lab.petebeegle.com/login/generic_oauth
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/grafana-groups]]
      sub_mode: hashed_user_id
      issuer_mode: per_provider
      access_code_validity: minutes=1
      access_token_validity: minutes=5
      refresh_token_validity: days=30

  # Application for Grafana
  - identifiers:
      slug: grafana
    model: authentik_core.application
    attrs:
      name: Grafana
      slug: grafana
      provider: !Find [authentik_providers_oauth2.oauth2provider, [name, grafana-provider]]
      policy_engine_mode: any
      meta_launch_url: https://monitoring.lab.petebeegle.com
      meta_icon: https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/png/grafana.png
      meta_description: Monitoring and observability dashboards
      open_in_new_tab: true
